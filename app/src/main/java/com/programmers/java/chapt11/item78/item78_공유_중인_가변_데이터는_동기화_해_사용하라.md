ì´í™í‹°ë¸Œ ìë°” + ë°¸ë‘¥(ë°œë“±?baeldung) ë‚´ìš© ë°”íƒ•ìœ¼ë¡œ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤. ì•½ê°„ ê°œì¸ì˜ ì¶”ë¡ ì ì¸ ë‚´ìš©ë„ ë“¤ì–´ìˆì–´ì„œ ì˜ë¬¸ìŠ¤ëŸ¬ìš´ ë¶€ë¶„ì— ëŒ€í•´ ì§€ì í•´ì£¼ì‹œë©´ ê°ì‚¬ í•˜ê² ìŠ´ë‹¤!

# ë™ê¸°í™” ?

## **ì›ìì„± ì´ ë³´ì¥ë˜ëŠ” ì—°ì‚°ì´ë¼ë©´ , ë¬´ì¡°ê±´ ë™ê¸°í™”ê°€ ë˜ëŠ” ê²ƒì´ë¼ ë³¼ ìˆ˜ ìˆì„ê¹Œ ? â†’ NO!**

ìš°ë¦¬ëŠ” ë™ê¸°í™”ì˜ ì˜ë¯¸ì— ëŒ€í•´ ìƒê°í•´ ë³¼ í•„ìš”ê°€ ìˆë‹¤.

- **â€˜ë°°íƒ€ì  ì‹¤í–‰â€™** ì„ ìœ„í•œ ê²ƒ
    - ( Critical Section ì„ **í•œ ë²ˆì— í•˜ë‚˜ì˜ job ì—ì„œë§Œ ì ‘ê·¼(read,write) ê°€ëŠ¥**í•˜ë„ë¡ í•˜ëŠ” ê²ƒ )
- ë™ê¸°í™”ëŠ” â€˜ **ì–´ë–¤ ìŠ¤ë ˆë“œ ê°€ *ë§Œë“¤ê³  ìˆëŠ” ë³€í™”ë¥¼*, *ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ í™•ì¸ í•˜ì§€ ëª» í•˜ë„ë¡* â€˜ í•˜ëŠ” ê¸°ëŠ¥**ì´ ìˆë‹¤. ( íŠ¸ëœì­ì…˜ ì´ ë– ì˜¤ë¥¸ë‹¤ )
    - **ì¼ê´€ë˜ì§€ ëª»í•œ ìˆœê°„ì˜ ìƒíƒœë¥¼, ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ë³¼ ìˆ˜ ì—†ë„ë¡** í•œë‹¤ â†’ **ê·¸ ì´ì „ê¹Œì§€ ë°˜ì˜ëœ ìƒíƒœëŠ” ë‹¤ë¥¸ìŠ¤ë ˆë“œì—ì„œ ë³¼ ìˆ˜ ìˆ**ë„ë¡ í•œë‹¤.
    - ê·¸ë ‡ë‹¤ë©´.. ì´ ë§ì€  **ì–´ë–¤ ìŠ¤ë ˆë“œ ê°€ ì™„ë£Œì‹œí‚¨ ë³€í™”ëŠ”, ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆê²Œ ëœ ë‹¤ëŠ” ê²ƒ**ì„ ì˜ë¯¸í•˜ëŠ” ê²ƒê³¼ë„ ê°™ë‹¤ê³  ìƒê°í•œë‹¤.
- ì–´ë–¤ ìŠ¤ë ˆë“œ ê°€ ì–´ë–¤ ë³€í™”ë¥¼ ì™„ë£Œ ì‹œí‚¨ë‹¤ë©´ **â€œí•˜ë‚˜ì˜ ì¼ê´€ëœ ìƒíƒœ â†’ ë‹¤ë¥¸ ì¼ê´€ëœ ìƒíƒœâ€ ë¡œ ë³€í™”** ì‹œí‚¨ ê²ƒì¼ ê²ƒì´ë‹¤.
- ì´ë²ˆ ì•„ì´í…œ ì—ì„œëŠ” ì—¬ê¸°ì— ì§‘ì¤‘í•œë‹¤
    - **ë™ê¸°í™”ê°€ *ì—†ìœ¼ë©´,* í•œ ìŠ¤ë ˆë“œì—ì„œ ë§Œë“  ë³€í™”ë¥¼ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ í™•ì¸ ëª» í•  ìˆ˜ë„** ìˆë‹¤. ( ì™„ë£Œì‹œí‚¨ ë³€í™”ì„ì—ë„ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ í™•ì¸ì„ ëª»í•œë‹¤ê³ ??? ì™œì§€..???? ?? ë’¤ì—ì„œ ì°¨ì°¨ ì‚´í´ë³¸ë‹¤!! )

***ê³µìœ  ì¤‘ì¸ ê°€ë³€ ë°ì´í„°ë¥¼ ì›ìì  ìœ¼ë¡œ ì½ê³  ì“¸ ìˆ˜*** ìˆë”ë¼ë„, ***ë™ê¸°í™”ì— ì‹¤íŒ¨í•œë‹¤ë©´*** ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚ ê¹Œ?

## ì˜ˆì‹œ)ì›ìì ì¸ ì—°ì‚°ì— ëŒ€í•´ ë™ê¸°í™”í•˜ì§€ ì•Šì€ ê²½ìš° ë°œìƒí•˜ëŠ” ì¼ê³¼ ê·¸ ì›ì¸ ( Reordering, Cache coherence)

ë‹¤ìŒê³¼ ê°™ì´, **ê³µìœ ì¤‘ì¸ ê°€ë³€ ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ” ìƒí™©**ì´ ìˆë‹¤. ì—¬ê¸°ì„œëŠ” ì´ ê³µìœ ì¤‘ì¸ ê°€ë³€ ë°ì´í„°ì— ëŒ€í•´ ë™ì‹œì— ì›ìì ì¸ ì—°ì‚°ì„ í•˜ë ¤ê³  í•œë‹¤.

ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ, ë˜ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰í•˜ê³  ìˆë‹¤.

ë©€í‹°ì½”ì–´ ì‹œìŠ¤í…œì´ë¼ë©´, ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ì´ ë©€í‹° ìŠ¤ë ˆë“œë“¤ ì¤‘ ì¼ë¶€ê°€ ë³‘ë ¬ë¡œ ì‹¤í–‰ë˜ê³  ìˆì„ ê²ƒì´ë‹¤.

ìƒˆë¡­ê²Œ ìƒì„±ëœ ìŠ¤ë ˆë“œ ë‚´ë¶€ì—ì„œëŠ” `**stopRequested**` ê°’ì— ëŒ€í•´ polling í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

```java
private class StopThread {
    private static booleanstopRequested;

    public void run() throws InterruptedException {
        Thread backgroundThread = new Thread(() -> {
            int i = 0;
            while (!stopRequested) {
                i++;
            }
        });
        backgroundThread.start();

        TimeUnit.SECONDS.sleep(1);
				stopRequested= true;
    }
}
```

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ !

- **Java ì–¸ì–´ ëª…ì„¸ìƒ, boolean í•„ë“œì— ëŒ€í•œ read, write** ëŠ” **ì›ìì ì¸ ì‘ì—…ì´ë‹¤.  ( ì¦‰, ê¸°ê³„ì–´ë¡œ ë²ˆì—­ ë˜ë”ë¼ë„ ì—¬ëŸ¬ê°œì˜ instruction ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆì§€ëŠ” ì•Šì„ ê²ƒ**ì´ë‹¤ < â€” > **ì´ì™€ ìƒë°˜ë˜ê²Œ, ë’¤ì—ì„œ ë³´ê² ìœ¼ë‚˜ ì¦ê° ì—°ì‚°ìëŠ” ì›ìì ì´ì§€ ì•Šì€ ì‘ì—…**ì´ë‹¤ `++, â€”` ì—°ì‚°ì )

ì•„ë¬´íŠ¼ ê·¸ë ‡ë‹¤ë©´ ìš°ë¦¬ëŠ” ì´ëŸ° ì˜ˆìƒì„ í•  ê²ƒì´ë‹¤.

> ì–¼ë§ˆ ì•ˆ ìˆì–´ í”„ë¡œê·¸ë¨ì€ ì¢…ë£Œ ë˜ê² ì§€? ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ true ë¡œ ì—…ë°ì´íŠ¸í•´ì£¼ê¸°ë§Œ í•˜ë©´ ë˜ëŠ”ê±°ê³ , ì‹¤ì œ ë©”ì¸ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰í•˜ëŠ” ë¶€ë¶„ì—ëŠ” stopRequested  ìƒíƒœë¥¼ true ë¡œ ì—…ë°ì´íŠ¸ í•´ ì£¼ê³  ìˆìœ¼ë‹ˆê¹Œ!
>

í•˜ì§€ë§Œ *ë‚´ ì»´í“¨í„°ì—ì„œ ìœ„ì˜ ì½”ë“œëŠ” ë¬´í•œ ë£¨í”„ë¥¼ ëŒê³  ìˆì—ˆë‹¤*.

- ì™€ ê·¼ë° ì´ê±°ëŠ” static ê³µê°„ì´ë¼ì„œ ê·¸ëŸ° ê²ƒ ê°™ê¸°ë„..

  ê°ì²´ì— ëŒ€í•´ì„œ í•˜ë‹ˆê¹Œ ì •ìƒ ì¢…ë£Œí•¨ ã„¸; ?


ì•ì„œ ì‚´ì§ ì–¸ê¸‰ëœ ë¶€ë¶„ì´ë‹¤.

> **ë™ê¸°í™”ê°€ ì—†ìœ¼ë©´, í•œ ìŠ¤ë ˆë“œì—ì„œ ë§Œë“  ë³€í™”ë¥¼ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ í™•ì¸ í•˜ëŠ” ê²ƒì´ ì–¸ì œê°€ ë ì§€ ë³´ì¦ í•  ìˆ˜ ì—†ë‹¤.**
>

ê·¸ ì›ì¸ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- 1ï¸âƒ£Â  ***ì»´íŒŒì¼ëŸ¬ì—ì„œ ì´ëŸ°ì‹ì˜ ìµœì í™”(hoisting)ë¥¼ í•¨ìœ¼ë¡œì„œ  Rerodering(ìˆœì„œ ì¬ë°°ì¹˜) ì¼ì–´ë‚  ìˆ˜ë„ ìˆë‹¤.***
    - ì¦‰, ìš°ë¦¬ê°€ ***í”„ë¡œê·¸ë˜ë° í•œ ì½”ë“œ ìˆœì„œëŒ€ë¡œ! ì‹¤í–‰ì´ ë˜ì§€ ì•Šì„ ìˆ˜ë„!*** ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.

    ```java
    while(!stopRequested){
    	i++;
    }
    ```

  ìœ„ì™€ ê°™ì€ ì½”ë“œê°€, ì»´íŒŒì¼ëŸ¬ ìµœì í™”ì— ì˜í•´ ì•„ë˜ì™€ ê°™ì´ ë  ìˆ˜ê°€ ìˆë‹¤.

    ```java
    if(!stopRequested) {
    	while(true){
    		i++;
    	}
    }
    ```

  ì´ ê²½ìš°, ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì´ˆê¸°í™” ë˜ì—ˆë˜ stopRequested ìƒíƒœ ê°’ ë§Œìœ¼ë¡œ  ì¡°ê±´ì„ ê²€ì¦í•˜ê³ , while ë£¨í”„ë¥¼ ê³„ì† ëŒê²Œ ë˜ê¸° ë•Œë¬¸ì— ë¬´í•œ ë£¨í”„ì— ë¹ ì§€ê²Œ ëœë‹¤.

- 2ï¸âƒ£Â  ë˜í•œ, **í”„ë¡œì„¸ì„œì˜ cache ë¡œ ì¸í•œ Memory visibility ì™€ ê´€ë ¨ ë˜ì–´ ìˆì„ ìˆ˜ë„** ìˆë‹¤( ê°„ë‹¨íˆ ì–˜ê¸°í•˜ë©´ , **write ì‘ì—…ì„ ì¦‰ì‹œ ì²˜ë¦¬í•˜ì§€ ì•Šê³ , í”„ë¡œì„¸ì„œì˜ ìºì‹œì— write buffering** ì„ í•˜ë‹¤ ë³´ë‹ˆ, **ë©”ëª¨ë¦¬ì— ì‹¤ì œë¡œ write í•˜ëŠ” ê²ƒì€ ë” ëŠë¦¬ë‹¤**. ì´ì— ë”°ë¼ ê° ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰ ì‹œí‚¤ëŠ” ì½”ì–´ë“¤ì˜ ìºì‹œ ì‚¬ì´ì— ë°ì´í„° ì¼ê´€ì„± ë¶ˆì¼ì¹˜ê°€ ìƒê¸°ëŠ” ê²ƒì´ë‹¤.)

ê²°ê³¼ì ìœ¼ë¡œ  *ì˜ˆìƒí•œ ë™ì‘ì´ ì¼ì–´ë‚˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤*

## ë™ê¸°í™”ë¥¼ í•˜ì. ê·¸ëŸ°ë° â€œì“°ê¸°â€ ë§Œì´ ì•„ë‹Œ â€œì½ê¸°â€ë„ !

> **ì“°ê¸°, ì½ê¸° ëª¨ë‘ê°€ ë™ê¸°í™” ë˜ì§€ ì•Šìœ¼ë©´, ë™ì‘ ì„ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤!!**
>

### ë°©ë²• 1 ) synchronized ì‚¬ìš© â†’ **ê³µìœ  ë³€ìˆ˜ì— ëŒ€í•œ ì ‘ê·¼ ì˜ì—­ì— ëŒ€í•´ synchronized ë¥¼ ë¶™ì—¬**ì£¼ë©´ ëœë‹¤

```java
public class StopThread {

    private static boolean stopRequested;
		
		// write
    private static synchronized void requestStop() {
				stopRequested= true;
    }
		
		// read 
    private static synchronized boolean stopRequested() {
        return stopRequested;
    }

    public static void main(String[] args)
        throws InterruptedException {
        Thread backgroundThread = new Thread(() -> {
            int i = 0;
            while (!stopRequested()) {
                i++;
            }
        });
        backgroundThread.start();

        TimeUnit.SECONDS.sleep(1);
				requestStop();
    }
}
```

### ë°©ë²• 2 ) volatile ì‚¬ìš© â†’ ë³€ìˆ˜ ìì²´ ì„ ì–¸ì‹œ volatile í‚¤ì›Œë“œë¥¼ ë¶™ì¸ë‹¤ â†’ ê·¸ëŸ¼, **í•­ìƒ ê°€ì¥ ìµœê·¼ì— ê¸°ë¡ëœ ê°’ì„ ì½ê²Œ ë¨ì´ ë³´ì¥**

> volatile í‚¤ì›Œë“œë¥¼ ë¶™ì¼ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ ì¼ì´ ì¼ì–´ë‚˜ê¸° ë•Œë¬¸ì´ë‹¤
>
- **volatile ë³€ìˆ˜ê°€ í¬í•¨ëœ instruction ì— ëŒ€í•œ reordering ì´ ì¼ì–´ë‚˜ì§€ ì•Šê²Œ** í•œë‹¤.
- **í”„ë¡œì„¸ì„œë“¤ì€, volatile ë³€ìˆ˜ì— ëŒ€í•œ ëª¨ë“  ì—…ë°ì´íŠ¸ë¥¼ ì¦‰ê°ì ìœ¼ë¡œ (â†’ ë©”ëª¨ë¦¬ë¡œ) flush í•œë‹¤**.

```java
public class StopThread {
    private static volatile boolean stopRequested;

    public static void main(String[] args)
            throws InterruptedException {
        Thread backgroundThread = new Thread(() -> {
            int i = 0;
            while (!stopRequested)
                i++;
        });
        backgroundThread.start();

        TimeUnit.SECONDS.sleep(1);
        stopRequested = true;
    }
}
```

## í•˜ì§€ë§Œ, ì›ìì  ì—°ì‚°ì´ ì•„ë‹Œ ì¦ê°ì—°ì‚°ìì˜ ê²½ìš°ëŠ” volatile ìœ¼ë¡  í•´ê²°ë˜ì§€ ì•ŠëŠ”ë‹¤

> ğŸ’¥Â **WARNING** â€” ***volatile â‰  atomic!***
>
> - **volatile ì€ ë‹¤ë¥¸ ì½”ì–´ì—ë„ í•´ë‹¹ ë³€í™”ì— ëŒ€í•œ visibility ë¥¼ ì œê³µí•  ë¿**ì´ë‹¤.
> - **AtomicInteger ëŠ” visibility ì™€ atomicity ëª¨ë‘ë¥¼ ì œê³µ**í•œë‹¤.

### volatile í‚¤ì›Œë“œì—ë§Œ ì˜ì¡´í•œ ì¦ê°ì—°ì‚° ì˜ˆì‹œ

ìœ„ì˜ ì˜ˆì‹œì˜ ê²½ìš°ì—ëŠ”, JAVA ì–¸ì–´ ëª…ì„¸ìƒ boolean í•„ë“œì— ëŒ€í•œ ì½ê¸°, ì“°ê¸° ì‘ì—… ìì²´ê°€ ì›ìì  ì´ì—ˆë‹¤.

í•˜ì§€ë§Œ ë§Œì•½, **ì›ìì ì¸ ì—°ì‚°ì´ ì•„ë‹Œ ê²½ìš°ë¼ë©´ ? í•„ë“œë¥¼ volatile ë¡œ ì„ ì–¸í•œ ê²ƒìœ¼ë¡œëŠ” ì¶©ë¶„í•˜ì§€ ì•Šê²Œ** ëœë‹¤.

ì˜ˆë¥¼ë“¤ì–´ ë‹¤ìŒê³¼ ê°™ì´, í•­ìƒ ìœ ë‹ˆí¬í•œ ì‹œë¦¬ì–¼ ë„˜ë²„ë¥¼ ìƒì„±í•˜ëŠ” ëª©ì ì˜ generateSerialNumber() ë©”ì†Œë“œê°€ ìˆë‹¤ê³  í•˜ì.

```java
private static volatile int nextSerialNumber = 0;

public static int generateSerialNumber() {
	return nextSerialNumber++;
}
```

í•˜ì§€ë§Œ ëª¨ë‘ ì•Œê² ì§€ë§Œ **ì¦ê° ì—°ì‚°ìëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë‘ê°€ì§€ ì—°ì‚°ì´ ì¼ì–´ ë‚œë‹¤(** ì›ìì  ì—°ì‚°ì´ ì—¬ëŸ¬ê°œ í•„ìš”í•˜ë‹¤ )

ë”°ë¼ì„œ *ìš°ë¦¬ê°€ ì˜ˆìƒí•œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤*( ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ **ì¤‘ë³µëœ ì‹œë¦¬ì–¼ ë„˜ë²„ë¥¼ ì–»ì–´ê°„ë‹¤** )

```java
class SerialNumberTest {
    private static volatile intserialNumber1= 0;
		public static int generateSerialNumber1() {
        return serialNumber1++;
    }

		@Test
    @DisplayName("ì¼ë°˜ int ì¸ volatile ì„¤ì •ëœ ì‹œë¦¬ì–¼ ë„˜ë²„ì— ëŒ€í•˜ì—¬, 0 ë¶€í„° ì‹œì‘í•˜ì—¬ x ë²ˆ ë§Œí¼ serialNumber ë¥¼ í†µí•´ ìˆ˜ë¥¼ ì–»ì–´ì˜¤ëŠ” ìŠ¤ë ˆê°€ ë™ì‹œì— ë‹¤ìˆ˜ ì‹¤í–‰ë˜ëŠ” ê²½ìš°, ë‹¤ìŒ ë²ˆ serialNumber ëŠ” x ê°€ ì•„ë‹ ìˆ˜ë„ ìˆë‹¤")
    void givenVolatileInteger_whenIncrement_thenFail () throws InterruptedException {
        int x = 1000;

        ExecutorService threadPoolExecutor =
            Executors.newFixedThreadPool(10);

        IntStream.range(0,x)
            .forEach(i ->
                threadPoolExecutor.submit(SerialNumberTest::generateSerialNumber1));

        Thread.sleep(2000);

        Assertions.assertThat(generateSerialNumber1())
            .isNotEqualTo(x);
    }
}
```

ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œ?

- volatile ì€ ê·¸ì € ë³€ê²½ëœ ê°’ì„ ë°”ë¡œë°”ë¡œ ë©”ëª¨ë¦¬ë¡œ flush ë¥¼ í•´ ì£¼ë„ë¡ í•  ë¿ì´ë‹¤.
- ì—°ì‚° ìì²´ê°€ ì›ìì ì´ì§€ ì•Šê¸° ë•Œë¬¸ì—, ê²°êµ­ì€ ë™ì‹œì„± ì´ìŠˆê°€ ìƒê¸°ëŠ” ê²ƒì´ë‹¤.

### í›„ìœ„ ì¦ê° ì—°ì‚°ì ì—ì„œ ì¼ì–´ë‚˜ëŠ” ê³¼ì •ì„ atomic í•˜ê²Œ ë§Œë“¤ì–´ì¤€ë‹¤ë©´?

í›„ìœ„ ì¦ê°ì—°ì‚°ì€ ì‹¤ì œë¡œ

```java
a++; // ë¼ëŠ” ê²ƒì„ í•  ê²½ìš° ë‚´ë¶€ì ìœ¼ë¡œ

// ëŒ€ì¶© ì•„ë˜ì™€ ê°™ì€ ê³¼ì •ì„ ê±°ì¹˜ê²Œ ëœë‹¤
tempA = a;
tempA = tempA + 1; 
a = tempA; 
```

ì¦‰ ë‚´ë¶€ì ìœ¼ë¡œ ì›ìì ì´ì§€ ëª»í•˜ë‹¤.

ê·¸ëŸ°ë° JAVA ì—­ì‹œ, **ì´ ì¼ë ¨ì˜ ê³¼ì • ìì²´ê°€ ì›ìì ìœ¼ë¡œ ì¼ì–´ë‚  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” â€œíƒ€ì…â€** ì´ ì¡´ì¬í•œë‹¤.  â†’ `**AtomicXXX**`

```java
class SerialNumberTest {
    private static volatile AtomicLong nextSerialNumber = new AtomicLong();
		public static long generateSerialNumber2() {
        return nextSerialNumber.getAndIncrement();
    }

    @Test
    @DisplayName("AtomicInteger ì¸ volatile ì„¤ì •ëœ ì‹œë¦¬ì–¼ ë„˜ë²„ì— ëŒ€í•˜ì—¬, 0 ë¶€í„° ì‹œì‘í•˜ì—¬ x ë²ˆ ë§Œí¼ serialNumber ë¥¼ í†µí•´ ìˆ˜ë¥¼ ì–»ì–´ì˜¤ëŠ” ìŠ¤ë ˆê°€ ë™ì‹œì— ë‹¤ìˆ˜ ì‹¤í–‰ë˜ëŠ” ê²½ìš°ë”ë¼ë„, ë‹¤ìŒ ë²ˆ serialNumber ëŠ” x ì„ì„ ê¸°ëŒ€í•œë‹¤")
    void givenVolatileAtomicInteger_whenIncrement_thenSuccess() throws InterruptedException {
        int x = 1000;

        ExecutorService threadPoolExecutor =
            Executors.newFixedThreadPool(10);

        IntStream.range(0,x)
                .forEach(i ->
                    threadPoolExecutor.submit(SerialNumberTest::generateSerialNumber2));

        Thread.sleep(2000);

        Assertions.assertThat(generateSerialNumber2())
            .isEqualTo(x);
    }
}
```

### AtomicXX

AtomicInteger ì™€ ê°™ì€ ê²ƒì„ ì‚¬ìš©í•  ê²½ìš°, ê°œë°œìëŠ” ì§ì ‘ synchronized ì™€ ê°™ì€ lock ì„ ì‚¬ìš©í•œ êµ¬í˜„ì„ í•˜ì§€ ì•Šì•„ë„ ë™ê¸°í™” ê°€ ê°€ëŠ¥í•˜ë‹¤.

## ë©€í‹°ìŠ¤ë ˆë“œì—ì„œ ì•ˆì „í•˜ê²Œ ë°ì´í„° ê³µìœ í•˜ê¸° ìœ„í•´ì„  ( effectively immutable, safe publication )

ë‹¤ìŒê³¼ ê°™ì€ ë‘ê°€ì§€ ë°©ì‹ì„ ì œì‹œí•˜ê³  ìˆë‹¤.

ì´ì— ëŒ€í•´ì„œëŠ” ìì„¸í•œ ì„¤ëª…ì´ ì—†ê¸¸ë˜ ê°„ë‹¨í•˜ê²Œ ì°¾ì•„ë³´ì•˜ë‹¤. (ê·¼ë° ì´í•´ê°€ ì•ˆë˜ëŠ” ë¶€ë¶„ ë‹¤ìˆ˜ ì¡´ì¬)

- **effectively immutable**
    - immutable ê³¼ì˜ ì°¨ì´ê°€ ë­ì§€?
        - ë¶ˆë³€ê°ì²´ë¼ê³  í•˜ë©´ ë³´í†µ 1. í™•ì¥ ê°€ëŠ¥í•˜ì§€ ì•ŠìŒ 2. ëª¨ë“  í•„ë“œëŠ” final ë¡œ ì„ ì–¸í•˜ì—¬ â†’ ê°ì²´ ìƒì„±ì‹œ ì´ˆê¸°í™” ë˜ê³ , ì´í›„ì— ë³€ê²½í•  ìˆ˜ ì—†ë‹¤.
        - final ë¡œ ì„ ì–¸ë˜ì§€ ì•Šì•˜ì§€ë§Œ, ë©”ì†Œë“œ êµ¬í˜„ì„ í†µí•´ ì´ˆê¸°í™” ì´í›„ ë³€ê²½ë  ìˆ˜ ì—†ë„ë¡ êµ¬í˜„ëœ ê²ƒì„ effectively immutable ì´ë¼ê³  ë¶€ë¥´ëŠ” ê²ƒ ê°™ë‹¤. â€”â†’ ì—¬ê¸°ì—ëŠ”, ë©”ì†Œë“œë¥¼ í†µí•´ í•´ë‹¹ í•„ë“œë¥¼ ë¦¬í„´í•  ë•Œ ë§ˆë‹¤, ìƒˆë¡œìš´ ê°ì²´ë¡œ ë³µì‚¬í•´ì„œ ë¦¬í„´í•˜ëŠ” ë°©ë²•ì´ í•´ë‹¹ëœë‹¤. ì™œëƒí•˜ë©´ ì´ë ‡ê²Œ ë§Œë“¤ ê²½ìš°, í•´ë‹¹ ê°ì²´ì˜ ìƒíƒœ ìì²´ëŠ” ì™¸ë¶€ì—ì„œ ë³€ê²½í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•´ì§€ê¸° ë•Œë¬¸ì´ë‹¤.  â€”> ì¦‰, ë™ì‹œì— ì‹¤í–‰ì¤‘ì¸ ìŠ¤ë ˆë“œ ê°ê°ì—ì„œ ì ‘ê·¼í•˜ëŠ” ê°ì²´ë“¤ì´ ê²°êµ­ ì„œë¡œ ë‹¤ë¥¸ ê°ì²´ ì´ë„ë¡ í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ëŠ” ê²ƒ ê°™ë‹¤.( ğŸ¤”â“Â ì˜ ëª¨ë¥´ê² ë‹¤)
- **safe publication í…Œí¬ë‹‰?**
    - **all the values written before the publication visible to all readers that observed the published object ( ê·¸ ê°ì²´ê°€ ë°œí–‰ë˜ê¸° ì´ì „ì— ì¼ì–´ë‚œ ëª¨ë“  ë³€í™”ë“¤ì´, í•´ë‹¹ ê°ì²´ë¥¼ êµ¬ë…í•˜ê³  ìˆëŠ” ë…ìë“¤ì—ê²Œ visible í•´ì•¼ í•œë‹¤**
    - **â†’ ì•ì—ì„œ ê³„ì† ë§í•´ì™”ë˜ ë™ê¸°í™”ì™€ visiblity ì— ëŒ€í•œ ê°œë… ê°™ë‹¤. ê·¸ë˜ì„œ ì´ í…Œí¬ë‹‰ ë“¤ì„ ì°¾ì•„ë³´ë©´**
        - synchronized
        - volatile
        - Atomic

      ë“±ë“±ì´ ë‚˜ì˜¤ê²Œ ëœë‹¤. í•œ ë²ˆ ì°¾ì•„ë³´ì ~


ì˜ ë°©ì‹ì„ ì œì‹œí•˜ê³  ìˆë‹¤.

## ê²°ë¡ 

> **ê°€ë³€ ë°ì´í„°ëŠ”, ë‹¨ì¼ ìŠ¤ë ˆë“œì—ì„œë§Œ ì‚¬ìš©**í•˜ì.
>

> ê°€ë³€ ë°ì´í„°ë¥¼ **ê³µìœ í•œë‹¤ë©´, í•´ë‹¹ ë°ì´í„°ì— ëŒ€í•œ ì½ê¸°/ì“°ê¸° ì‘ì—…ì€ ë°˜ë“œì‹œ ë™ê¸°í™”** í•˜ì. (ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œë„ ë³¼ ìˆ˜ ìˆë„ë¡! )
>
>
> ë°°íƒ€ì  ì‹¤í–‰ê¹Œì§€ í•„ìš”í•œê²Œ ì•„ë‹ˆë¼ë©´, volatile ì„ í†µí•´, ìŠ¤ë ˆë“œ ê°„ì˜ í†µì‹ ì´ ì˜ ë™ê¸°í™” ë˜ëŠ” ê²ƒì´ë¼ë„ í•  ìˆ˜ ìˆë‹¤. ( í•˜ì§€ë§Œ volatile ì„ ì˜ ì‚¬ìš©í•˜ëŠ” ê²ƒ ì—­ì‹œ ë§¤ìš° ê¹Œë‹¤ë¡­ë‹¤ê³  í•œë‹¤ )
>
- increment ì²˜ëŸ¼ ë‚´ë¶€ì ìœ¼ë¡œ ì—¬ëŸ¬ ì—°ì‚°ì´ ì¼ì–´ë‚˜ëŠ” ê²½ìš°ê°€ ì¡´ì¬í•œë‹¤ëŠ” ê²ƒì„ ë³´ì•˜ë‹¤.
- ë”°ë¼ì„œ ì‚¬ìš©í•˜ëŠ” í”„ë ˆì„ì›Œí¬, ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–¤ ì—°ì‚°ì´ ì¼ì–´ë‚˜ëŠ”ì§€ ê¹Šì´ ì•„ëŠ” ê²ƒì´ ì¢‹ë‹¤.

## ì°¸ì¡°

[https://www.baeldung.com/java-volatile](https://www.baeldung.com/java-volatile)

[https://brooker.co.za/blog/2012/11/13/increment.html](https://brooker.co.za/blog/2012/11/13/increment.html)

[https://shipilev.net/blog/2014/safe-public-construction/](https://shipilev.net/blog/2014/safe-public-construction/)

[https://shipilev.net/blog/2014/safe-public-construction/](https://shipilev.net/blog/2014/safe-public-construction/)